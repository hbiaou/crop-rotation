{% extends "base.html" %}

{% block title %}{{ i18n.pages.settings_title }} ‚Äî {{ i18n.nav.app_title }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">‚öôÔ∏è {{ i18n.pages.settings_title }}</h1>
    <p class="page-subtitle">Configuration des jardins, cultures, rotation et sauvegardes</p>
</div>

<!-- Forward-only warning -->
<div class="settings-warning">
    <span class="settings-warning-icon">‚ö†Ô∏è</span>
    <span>{{ i18n.messages.warning_settings_forward }}</span>
</div>

<!-- Tabs Navigation -->
<div class="tabs-container">
    <div class="tabs-nav" role="tablist">
        <button class="tab-btn active" data-tab="jardins" role="tab" aria-selected="true" title="Jardins">
            <span class="tab-icon"><img src="{{ url_for('static', filename='images/garden-icon.png') }}" alt="Jardins" width="18" height="18"></span>
            <span class="tab-label">Jardins</span>
        </button>
        <button class="tab-btn" data-tab="cultures" role="tab" aria-selected="false" title="Cultures">
            <span class="tab-icon">üåæ</span>
            <span class="tab-label">Cultures</span>
        </button>
        <button class="tab-btn" data-tab="plantes" role="tab" aria-selected="false" title="Base Plantes">
            <span class="tab-icon">üå±</span>
            <span class="tab-label">Base Plantes</span>
        </button>
        <button class="tab-btn" data-tab="rotation" role="tab" aria-selected="false" title="S√©quence">
            <span class="tab-icon">üîÑ</span>
            <span class="tab-label">S√©quence</span>
        </button>
        <button class="tab-btn" data-tab="cycles" role="tab" aria-selected="false" title="Cycles">
            <span class="tab-icon">üìÖ</span>
            <span class="tab-label">Cycles</span>
        </button>
        <button class="tab-btn" data-tab="distribution" role="tab" aria-selected="false" title="R√©partition">
            <span class="tab-icon">üìä</span>
            <span class="tab-label">R√©partition</span>
        </button>
        <button class="tab-btn" data-tab="sauvegardes" role="tab" aria-selected="false" title="Sauvegardes">
            <span class="tab-icon">üíæ</span>
            <span class="tab-label">Sauvegardes</span>
        </button>
        <button class="tab-btn tab-btn-danger" data-tab="danger" role="tab" aria-selected="false" title="Zone de Danger">
            <span class="tab-icon">‚ö†Ô∏è</span>
            <span class="tab-label">Zone de Danger</span>
        </button>
        <button class="tab-btn" data-tab="import" role="tab" aria-selected="false" title="Import">
            <span class="tab-icon">üì•</span>
            <span class="tab-label">Import</span>
        </button>
    </div>

    <!-- ============================================
         TAB 1: JARDINS
         ============================================ -->
    <div class="tab-panel active" id="tab-jardins" role="tabpanel">
        <!-- Existing Gardens -->
        {% for gd in garden_data %}
        <div class="card">
            <div class="card-header d-flex align-center justify-between">
                <h2 class="card-title">üåø {{ gd.garden.garden_code }} ‚Äî {{ gd.garden.name }}</h2>
                <div class="d-flex gap-sm">
                    <button class="btn btn-sm btn-secondary" onclick="toggleEditGarden('{{ gd.garden.id }}')">
                        ‚úèÔ∏è {{ i18n.buttons.edit }}
                    </button>
                    <form method="POST" action="{{ url_for('settings.garden_delete') }}" style="display:inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="garden_id" value="{{ gd.garden.id }}">
                        <button type="submit" class="btn btn-sm btn-danger"
                            data-confirm="√ätes-vous s√ªr de vouloir supprimer ce jardin ?">
                            üóëÔ∏è {{ i18n.buttons.delete }}
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <!-- Stats -->
                <div class="stats-grid stats-grid-3">
                    <div class="stat-item">
                        <span class="stat-value">{{ gd.stats.beds }}</span>
                        <span class="stat-label">{{ i18n.stats.beds }}</span>
                    </div>
                    <div class="stat-item stat-active">
                        <span class="stat-value" id="active-count-{{ gd.garden.id }}">{{ gd.stats.active_sub_beds
                            }}</span>
                        <span class="stat-label">{{ i18n.stats.active }}</span>
                    </div>
                    <div class="stat-item stat-reserve">
                        <span class="stat-value" id="reserve-count-{{ gd.garden.id }}">{{ gd.stats.reserve_sub_beds
                            }}</span>
                        <span class="stat-label">{{ i18n.stats.reserve }}</span>
                    </div>
                </div>

                <div class="garden-meta mb-md">
                    <span class="meta-item">üìè {{ gd.garden.bed_length_m }}m √ó {{ gd.garden.bed_width_m }}m</span>
                    <span class="meta-item">üî≤ {{ gd.garden.sub_beds_per_bed }} sous-planches/planche</span>
                    <span class="meta-item">üìê {{ (gd.garden.bed_length_m / gd.garden.sub_beds_per_bed)|round(1) }}m par
                        sous-planche</span>
                </div>

                <!-- Edit Form (hidden by default) -->
                <div class="edit-garden-form" id="edit-garden-{{ gd.garden.id }}" style="display:none">
                    <form method="POST" action="{{ url_for('settings.garden_edit') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="garden_id" value="{{ gd.garden.id }}">
                        <div class="form-row form-row-4">
                            <div class="form-group">
                                <label class="form-label" for="edit-garden-name-{{ gd.garden.id }}">{{ i18n.labels.garden_name }}</label>
                                <input type="text" name="name" id="edit-garden-name-{{ gd.garden.id }}" class="form-input" value="{{ gd.garden.name }}" required autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="edit-garden-beds-{{ gd.garden.id }}">{{ i18n.labels.bed_count }}</label>
                                <input type="number" name="beds" id="edit-garden-beds-{{ gd.garden.id }}" class="form-input" value="{{ gd.garden.beds }}" min="1"
                                    required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="edit-garden-length-{{ gd.garden.id }}">{{ i18n.labels.bed_length }}</label>
                                <input type="number" name="bed_length_m" id="edit-garden-length-{{ gd.garden.id }}" class="form-input"
                                    value="{{ gd.garden.bed_length_m }}" step="0.1" min="0.1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="edit-garden-width-{{ gd.garden.id }}">{{ i18n.labels.bed_width }}</label>
                                <input type="number" name="bed_width_m" id="edit-garden-width-{{ gd.garden.id }}" class="form-input"
                                    value="{{ gd.garden.bed_width_m }}" step="0.1" min="0.1" required>
                            </div>
                        </div>
                        <div class="form-row form-row-4 mt-md">
                            <div class="form-group">
                                <label class="form-label" for="edit-garden-subbeds-{{ gd.garden.id }}">{{ i18n.labels.sub_beds_per_bed }}</label>
                                <input type="number" name="sub_beds_per_bed" id="edit-garden-subbeds-{{ gd.garden.id }}" class="form-input"
                                    value="{{ gd.garden.sub_beds_per_bed }}" min="1" required>
                            </div>
                            <div class="form-group" style="align-self: end">
                                <button type="submit" class="btn btn-primary">{{ i18n.buttons.save }}</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Sub-bed Reserve Grid -->
                <div class="sub-bed-section mt-md">
                    <h3 class="sub-bed-section-title">
                        Sous-planches ‚Äî Actives / R√©serve
                        <button class="btn btn-sm btn-secondary" onclick="toggleSubBedGrid('{{ gd.garden.id }}')">
                            Afficher/Masquer la grille
                        </button>
                    </h3>
                    <div class="sub-bed-grid-container" id="sub-bed-grid-{{ gd.garden.id }}" style="display:none">
                        <div class="sub-bed-grid">
                            {% set ns = namespace(current_bed=0) %}
                            {% for sb in gd.sub_beds %}
                            {% if sb.bed_number != ns.current_bed %}
                            {% if ns.current_bed != 0 %}</div>{% endif %}
                        {% set ns.current_bed = sb.bed_number %}
                        <div class="sub-bed-row">
                            <span class="sub-bed-label">P{{ '%02d'|format(sb.bed_number) }}</span>
                            {% endif %}
                            <label class="sub-bed-cell {% if sb.is_reserve %}is-reserve{% endif %}"
                                title="P{{ '%02d'|format(sb.bed_number) }}-S{{ sb.sub_bed_position }}">
                                <input type="checkbox" data-sub-bed-id="{{ sb.id }}" data-garden-id="{{ gd.garden.id }}"
                                    {% if sb.is_reserve %}checked{% endif %} onchange="toggleReserve(this)">
                                <span class="sub-bed-name">S{{ sb.sub_bed_position }}</span>
                                <span class="sub-bed-status">{% if sb.is_reserve %}R{% else %}A{% endif %}</span>
                            </label>
                            {% endfor %}
                            {% if gd.sub_beds %}
                        </div>{% endif %}
                    </div>
                    <p class="form-hint mt-sm">Cochez une case pour mettre la sous-planche en r√©serve. D√©cochez pour la
                        remettre en active.</p>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Add Garden Form -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">‚ûï {{ i18n.buttons.add_garden }}</h2>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('settings.garden_add') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label class="form-label" for="add-garden-code">{{ i18n.labels.garden_code }}</label>
                        <input type="text" name="garden_code" id="add-garden-code" class="form-input" placeholder="J1" value="J" required
                            pattern="[A-Za-z0-9]+" title="Lettres et chiffres uniquement">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-garden-name">{{ i18n.labels.garden_name }}</label>
                        <input type="text" name="name" id="add-garden-name" class="form-input" placeholder="Nouveau Jardin" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-garden-beds">{{ i18n.labels.bed_count }}</label>
                        <input type="number" name="beds" id="add-garden-beds" class="form-input" placeholder="10" min="1" required>
                    </div>
                </div>
                <div class="form-row form-row-3 mt-md">
                    <div class="form-group">
                        <label class="form-label" for="add-garden-length">{{ i18n.labels.bed_length }}</label>
                        <input type="number" name="bed_length_m" id="add-garden-length" class="form-input" placeholder="25.0" step="0.1"
                            min="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-garden-width">{{ i18n.labels.bed_width }}</label>
                        <input type="number" name="bed_width_m" id="add-garden-width" class="form-input" value="1.0" step="0.1" min="0.1"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-garden-subbeds">{{ i18n.labels.sub_beds_per_bed }}</label>
                        <input type="number" name="sub_beds_per_bed" id="add-garden-subbeds" class="form-input" placeholder="2" min="1"
                            required>
                    </div>
                </div>
                <div class="mt-md">
                    <button type="submit" class="btn btn-accent">
                        <span class="btn-icon">‚ûï</span> {{ i18n.buttons.add_garden }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================
         TAB 2: CULTURES
         ============================================ -->
<div class="tab-panel" id="tab-cultures" role="tabpanel">
    <!-- Crops grouped by category -->
    {% for cat, cat_crops in crops_by_category.items() %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title d-flex align-center gap-sm">
                <span class="cat-badge cat-{{ cat|lower }}">{{ cat }}</span>
                <span class="text-muted">({{ cat_crops|length }} cultures)</span>
            </h2>
        </div>
        <div class="card-body">
            {% if cat_crops %}
            <div class="crops-list">
                {% for crop in cat_crops %}
                <div class="crop-item">
                    <div class="d-flex flex-col">
                        <span class="crop-name">{{ crop.crop_name }}</span>
                        {% if crop.family %}
                        <span class="text-muted text-xs">({{ crop.family }})</span>
                        {% endif %}
                    </div>
                    <div class="crop-actions d-flex gap-sm">
                        <!-- Category change -->
                        <form method="POST" action="{{ url_for('settings.crop_category') }}"
                            class="d-flex gap-sm align-center">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="crop_id" value="{{ crop.id }}">
                            <label class="sr-only" for="category-select-{{ crop.id }}">Cat√©gorie</label>
                            <select name="category" id="category-select-{{ crop.id }}" class="form-select form-select-sm" onchange="this.form.submit()">
                                {% for c in categories %}
                                <option value="{{ c }}" {% if c==crop.category %}selected{% endif %}>{{ c }}</option>
                                {% endfor %}
                            </select>
                        </form>
                        <!-- Delete -->
                        <form method="POST" action="{{ url_for('settings.crop_delete') }}" style="display:inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="crop_id" value="{{ crop.id }}">
                            <button type="submit" class="btn btn-sm btn-danger"
                                data-confirm="{{ i18n.confirm.delete_crop }}">
                                üóëÔ∏è
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">Aucune culture dans cette cat√©gorie.</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <!-- Add Crop Form -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">‚ûï {{ i18n.buttons.add_crop }}</h2>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('settings.crop_add') }}" id="addCropForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="plant_id" id="cropPlantId" value="">
                <div class="form-row">
                    <div class="form-group" style="position: relative;">
                        <label class="form-label" for="cropNameInput">{{ i18n.labels.crop_name }}</label>
                        <input type="text" name="crop_name" id="cropNameInput" class="form-input"
                            placeholder="Nom de la culture" required autocomplete="off"
                            oninput="searchPlantSuggestions(this.value)">
                        <div id="cropSuggestions" class="autocomplete-dropdown" style="display:none"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="cropCategorySelect">{{ i18n.labels.crop_category }}</label>
                        <select name="category" id="cropCategorySelect" class="form-select" required>
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="cropFamilyInput">Famille botanique</label>
                        <input type="text" name="family" id="cropFamilyInput" class="form-input" placeholder="Ex: Solanac√©es" autocomplete="off">
                    </div>
                </div>
                <div id="plantLinkInfo" class="form-hint text-success mt-sm" style="display:none"></div>
                <div class="mt-md">
                    <button type="submit" class="btn btn-accent">
                        <span class="btn-icon">‚ûï</span> {{ i18n.buttons.add_crop }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================
         TAB 3: S√âQUENCE DE ROTATION
         ============================================ -->
<div class="tab-panel" id="tab-rotation" role="tabpanel">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üîÑ {{ i18n.labels.rotation_sequence }}</h2>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('settings.rotation_save') }}" id="rotationForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="rotation-list" id="rotationList">
                    {% for step in rotation %}
                    <div class="rotation-item" data-category="{{ step.category }}">
                        <span class="rotation-position">{{ step.position }}</span>
                        <span class="cat-badge cat-{{ step.category|lower }}">{{ step.category }}</span>
                        <input type="hidden" name="categories" value="{{ step.category }}">
                        <div class="rotation-arrows">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="moveRotation(this, -1)" {%
                                if loop.first %}disabled{% endif %}>
                                ‚ñ≤
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="moveRotation(this, 1)" {% if
                                loop.last %}disabled{% endif %}>
                                ‚ñº
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Visual Preview -->
                <div class="rotation-preview mt-lg" id="rotationPreview">
                    <span class="rotation-preview-label">Aper√ßu :</span>
                    <div class="rotation-preview-chain" id="rotationPreviewChain">
                        {% for step in rotation %}
                        <span class="cat-badge cat-{{ step.category|lower }}">{{ step.category }}</span>
                        {% if not loop.last %}<span class="rotation-arrow">‚Üí</span>{% endif %}
                        {% endfor %}
                        <span class="rotation-arrow">‚Üí</span>
                        <span class="rotation-wrap">(retour √† {{ rotation[0].category }})</span>
                    </div>
                </div>

                <div class="mt-lg">
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">üíæ</span> {{ i18n.buttons.save }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================
         TAB 4: CYCLES PAR AN
         ============================================ -->
<div class="tab-panel" id="tab-cycles" role="tabpanel">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üìÖ {{ i18n.labels.cycles_per_year }}</h2>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('settings.cycles_save') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group" style="max-width: 300px">
                    <label class="form-label" for="cyclesSelect">Nombre de cycles par an</label>
                    <select name="cycles_per_year" class="form-select" id="cyclesSelect"
                        onchange="updateCyclePreview()">
                        <option value="1" {% if cycles_per_year=='1' %}selected{% endif %}>1 cycle par an</option>
                        <option value="2" {% if cycles_per_year=='2' %}selected{% endif %}>2 cycles par an</option>
                        <option value="3" {% if cycles_per_year=='3' %}selected{% endif %}>3 cycles par an</option>
                        <option value="4" {% if cycles_per_year=='4' %}selected{% endif %}>4 cycles par an</option>
                    </select>
                </div>

                <!-- Cycle Format Preview -->
                <div class="cycle-preview mt-lg" id="cyclePreview">
                    <span class="cycle-preview-label">Format des identifiants :</span>
                    <div class="cycle-preview-examples" id="cyclePreviewExamples">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="mt-lg">
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">üíæ</span> {{ i18n.buttons.save }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<!-- ============================================
         TAB 5: REPARTITION PAR DEFAUT
         ============================================ -->
<div class="tab-panel" id="tab-distribution" role="tabpanel">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üìä R√©partition par d√©faut</h2>
            <p class="text-muted">D√©finissez les pourcentages cibles par d√©faut pour chaque culture. Ces valeurs seront
                utilis√©es lors de la g√©n√©ration de nouveaux cycles.</p>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('settings.distribution_save') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% for cat in categories %}
                <div class="category-section mb-lg">
                    <h3 class="cat-title mb-md"><span class="cat-badge cat-{{ cat|lower }}">{{ cat }}</span></h3>

                    <div class="form-row form-row-3">
                        {% set cat_crops = crops_by_category[cat] %}
                        {% if cat_crops %}
                        {% for crop in cat_crops %}
                        <div class="form-group">
                            <label class="form-label" for="dist-crop-{{ crop.id }}">{{ crop.crop_name }} (%)</label>
                            <input type="number" name="crop_{{ crop.id }}" id="dist-crop-{{ crop.id }}" class="form-input"
                                value="{{ distribution_defaults.get(cat, {}).get(crop.crop_name, 0)|int }}" min="0"
                                max="100" step="1">
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted">Aucune culture.</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <div class="mt-lg">
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">üíæ</span> {{ i18n.buttons.save }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================
         TAB 6: SAUVEGARDES
         ============================================ -->
<div class="tab-panel" id="tab-sauvegardes" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex align-center justify-between">
            <h2 class="card-title">üíæ {{ i18n.glossary.backup }}</h2>
            <form method="POST" action="{{ url_for('settings.backup_create') }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-accent">
                    <span class="btn-icon">üì¶</span> Cr√©er une sauvegarde
                </button>
            </form>
        </div>
        <div class="card-body">
            {% if backups %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fichier</th>
                            <th>Date</th>
                            <th>Raison</th>
                            <th>Taille</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for backup in backups %}
                        <tr>
                            <td><code>{{ backup.filename }}</code></td>
                            <td>{{ backup.timestamp }}</td>
                            <td><span class="cat-badge cat-reserve">{{ backup.reason }}</span></td>
                            <td>{{ backup.size_display }}</td>
                            <td>
                                <div class="d-flex gap-sm">
                                    <form method="POST" action="{{ url_for('settings.backup_restore') }}"
                                        style="display:inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="filename" value="{{ backup.filename }}">
                                        <button type="submit" class="btn btn-sm btn-danger"
                                            data-confirm="{{ i18n.confirm.restore_backup }}">
                                            üîÑ {{ i18n.buttons.restore }}
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('settings.backup_delete') }}"
                                        style="display:inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="filename" value="{{ backup.filename }}">
                                        <button type="submit" class="btn btn-sm btn-secondary"
                                            data-confirm="{{ i18n.confirm.delete_backup }}">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <span class="empty-state-icon">üìÇ</span>
                <p>Aucune sauvegarde disponible.</p>
                <p class="text-muted">Cliquez sur ¬´ Cr√©er une sauvegarde ¬ª pour en cr√©er une.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ============================================
         TAB 6: DANGER ZONE
         ============================================ -->
<div class="tab-panel" id="tab-danger" role="tabpanel">
    {% for gd in garden_data %}
    <div class="card border-danger">
        <div class="card-header bg-danger-light">
            <h2 class="card-title text-danger">‚ö†Ô∏è R√©initialiser {{ gd.garden.garden_code }} ‚Äî {{ gd.garden.name }}</h2>
        </div>
        <div class="card-body">
            <p class="mb-md">
                Cette action va <strong>supprimer d√©finitivement tout l'historique</strong> (cycles pass√©s, plans
                futurs,
                r√©coltes) pour ce jardin.
                Le jardin lui-m√™me et sa configuration (planches, dimensions) seront conserv√©s.
            </p>
            <p class="mb-lg">
                Utilisez cette option si vous souhaitez recommencer la rotation √† z√©ro (ex: pour corriger un mauvais
                cycle
                de d√©part).
            </p>

            <form method="POST" action="{{ url_for('settings.garden_reset') }}"
                onsubmit="return confirm('√ätes-vous ABSOLIMENT s√ªr de vouloir effacer tout l\'historique de ce jardin ? Cette action est irr√©versible.');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="garden_id" value="{{ gd.garden.id }}">
                <button type="submit" class="btn btn-danger">
                    üí£ Tout effacer et recommencer √† z√©ro
                </button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

<!-- ============================================
         TAB 7: IMPORT
         ============================================ -->
<div class="tab-panel" id="tab-import" role="tabpanel">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üì• Importer des Donn√©es</h2>
        </div>
        <div class="card-body">
            <p class="mb-md">
                Vous pouvez importer un fichier JSON contenant les donn√©es d'un cycle pass√©.
                Cela est utile pour restaurer des sauvegardes manuelles ou importer des donn√©es g√©n√©r√©es.
            </p>

            <div class="alert alert-info">
                <strong>Format attendu :</strong> Un fichier JSON avec <code>garden_code</code>, <code>cycle</code>, et
                une liste de <code>beds</code>.
            </div>

            <form method="POST" action="{{ url_for('settings.import_cycle') }}" enctype="multipart/form-data"
                class="mt-md">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label class="form-label" for="importFile">Fichier JSON</label>
                    <input type="file" id="importFile" name="file" accept=".json" required class="form-input">
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-icon">üì§</span> Importer
                </button>
            </form>
        </div>
    </div>
</div>

<!-- ============================================
         TAB 9: BASE DE DONN√âES PLANTES
         ============================================ -->
<div class="tab-panel" id="tab-plantes" role="tabpanel">
    <!-- Database Status -->
    <div class="card mb-lg">
        <div class="card-header d-flex align-center justify-between">
            <h2 class="card-title">üå± Base de Donn√©es Plantes</h2>
            <div class="d-flex gap-sm align-center">
                {% if plant_db_healthy %}
                <span class="status-badge status-success">‚úì {{ plant_count }} plantes</span>
                {% else %}
                <span class="status-badge status-error">‚úó {{ plant_db_message }}</span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <p class="mb-md">
                Cette base de donn√©es contient les informations canoniques sur les plantes :
                noms scientifiques, familles botaniques, noms communs et synonymes.
                Elle permet l'auto-compl√©tion lors de la cr√©ation de cultures.
            </p>
            <div class="d-flex gap-sm">
                <a href="{{ url_for('plant_db.export_json') }}" class="btn btn-secondary">
                    <span class="btn-icon">üì•</span> Exporter JSON
                </a>
                <button type="button" class="btn btn-secondary" onclick="toggleImportPlants()">
                    <span class="btn-icon">üì§</span> Importer JSON
                </button>
            </div>

            <!-- Import Form (hidden by default) -->
            <div id="plant-import-form" style="display:none" class="mt-md">
                <form method="POST" action="{{ url_for('plant_db.import_json') }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="plant-import-file">Fichier JSON</label>
                            <input type="file" name="file" id="plant-import-file" accept=".json" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="plant-import-mode">Mode d'import</label>
                            <select name="mode" id="plant-import-mode" class="form-select">
                                <option value="merge">Fusionner (ajouter/mettre √† jour)</option>
                                <option value="replace">Remplacer tout (attention !)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-sm">
                        <button type="submit" class="btn btn-primary">Importer</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleImportPlants()">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Plant Form -->
    <div class="card mb-lg">
        <div class="card-header">
            <h2 class="card-title">‚ûï Ajouter une plante</h2>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('plant_db.add_plant') }}" id="addPlantForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label class="form-label" for="add-plant-scientific">Nom scientifique *</label>
                        <input type="text" name="scientific_name" id="add-plant-scientific" class="form-input"
                            placeholder="Ex: Solanum lycopersicum" required
                            onblur="checkPlantDuplicate(this)">
                        <span id="plant-dup-warning" class="form-hint text-danger" style="display:none"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-plant-family">Famille botanique</label>
                        <input type="text" name="family" id="add-plant-family" class="form-input" placeholder="Ex: Solanac√©es" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-plant-category">Cat√©gorie par d√©faut</label>
                        <select name="default_category" id="add-plant-category" class="form-select">
                            <option value="">‚Äî Aucune ‚Äî</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row form-row-3 mt-md">
                    <div class="form-group">
                        <label class="form-label" for="add-plant-preferred">Nom pr√©f√©r√© (affich√© par d√©faut)</label>
                        <input type="text" name="preferred_name" id="add-plant-preferred" class="form-input"
                            placeholder="Ex: Tomate">
                        <span class="form-hint">Le premier nom dans la liste des noms communs</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-plant-common">Autres noms communs (s√©par√©s par des virgules)</label>
                        <input type="text" name="common_names" id="add-plant-common" class="form-input"
                            placeholder="Ex: Pomme d'amour, Pomme d'or">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-plant-synonyms">Synonymes (s√©par√©s par des virgules)</label>
                        <input type="text" name="synonyms" id="add-plant-synonyms" class="form-input"
                            placeholder="Ex: Lycopersicon esculentum">
                    </div>
                </div>
                <div class="mt-md">
                    <button type="submit" class="btn btn-accent">
                        <span class="btn-icon">‚ûï</span> Ajouter la plante
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Plants List -->
    <div class="card">
        <div class="card-header d-flex align-center justify-between">
            <h2 class="card-title">üìã Liste des plantes</h2>
            <div class="form-group mb-0" style="width: 300px">
                <label class="sr-only" for="plantSearchInput">Rechercher une plante</label>
                <input type="text" id="plantSearchInput" class="form-input"
                    placeholder="Rechercher une plante..." oninput="filterPlantsList()">
            </div>
        </div>
        <div class="card-body">
            {% if plants %}
            <div class="table-container">
                <table id="plantsTable">
                    <thead>
                        <tr>
                            <th>Nom scientifique</th>
                            <th>Nom pr√©f√©r√©</th>
                            <th>Famille</th>
                            <th>Cat√©gorie</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plant in plants %}
                        <tr data-plant-id="{{ plant.id }}" data-search-text="{{ plant.search_text }}">
                            <td>
                                <strong>{{ plant.scientific_name }}</strong>
                            </td>
                            <td>{{ plant.preferred_name or '‚Äî' }}</td>
                            <td>{{ plant.family or '‚Äî' }}</td>
                            <td>
                                {% if plant.default_category %}
                                <span class="cat-badge cat-{{ plant.default_category|lower }}">{{ plant.default_category }}</span>
                                {% else %}
                                ‚Äî
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-sm">
                                    {% if plant.default_category %}
                                    <button type="button" class="btn btn-sm btn-accent"
                                        onclick="addPlantToCrops({{ plant.id }})"
                                        title="Ajouter aux cultures">
                                        ‚ûï
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-secondary"
                                        onclick="editPlant({{ plant.id }})">
                                        ‚úèÔ∏è
                                    </button>
                                    <form method="POST" action="{{ url_for('plant_db.remove_plant') }}" style="display:inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="plant_id" value="{{ plant.id }}">
                                        <button type="submit" class="btn btn-sm btn-danger"
                                            data-confirm="√ätes-vous s√ªr de vouloir supprimer cette plante ?">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <span class="empty-state-icon">üå±</span>
                <p>Aucune plante dans la base de donn√©es.</p>
                <p class="text-muted">Ajoutez des plantes avec le formulaire ci-dessus ou importez un fichier JSON.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Plant Edit Modal -->
<div id="plantEditModal" class="modal" style="display:none">
    <div class="modal-backdrop" onclick="closePlantModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Modifier la plante</h3>
            <button type="button" class="modal-close" onclick="closePlantModal()">&times;</button>
        </div>
        <div class="modal-body" id="plantEditModalBody">
            <!-- Loaded via AJAX -->
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ========================================
    // Tab Switching
    // ========================================
    document.querySelectorAll('.tab-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            // Deactivate all tabs
            document.querySelectorAll('.tab-btn').forEach(function (b) {
                b.classList.remove('active');
                b.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-panel').forEach(function (p) {
                p.classList.remove('active');
            });
            // Activate clicked tab
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');
            var tabId = 'tab-' + this.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');

            // Update URL with query param instead of hash
            var newUrl = new URL(window.location);
            newUrl.searchParams.set('tab', this.getAttribute('data-tab'));
            window.history.pushState({}, '', newUrl);
        });
    });

    // Restore tab from URL query param or hash
    (function () {
        var params = new URLSearchParams(window.location.search);
        var tabName = params.get('tab');

        // Fallback to hash if no query param
        if (!tabName && window.location.hash) {
            tabName = window.location.hash.replace('#', '');
        }

        if (tabName) {
            var btn = document.querySelector('.tab-btn[data-tab="' + tabName + '"]');
            if (btn) btn.click();
        }
    })();

    // ========================================
    // Garden: Toggle edit form
    // ========================================
    function toggleEditGarden(gardenId) {
        var form = document.getElementById('edit-garden-' + gardenId);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    // ========================================
    // Garden: Toggle sub-bed grid
    // ========================================
    function toggleSubBedGrid(gardenId) {
        var grid = document.getElementById('sub-bed-grid-' + gardenId);
        grid.style.display = grid.style.display === 'none' ? 'block' : 'none';
    }

    // ========================================
    // Sub-bed reserve toggle (AJAX)
    // ========================================
    function toggleReserve(checkbox) {
        var subBedId = checkbox.getAttribute('data-sub-bed-id');
        var gardenId = checkbox.getAttribute('data-garden-id');
        var isReserve = checkbox.checked ? '1' : '0';

        var formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('sub_bed_id', subBedId);
        formData.append('is_reserve', isReserve);

        fetch('{{ url_for("settings.sub_bed_toggle") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
            .then(function (response) {
                return response.json().then(function (data) {
                    return { ok: response.ok, data: data };
                });
            })
            .then(function (result) {
                if (result.ok && result.data.success) {
                    // Update counts
                    document.getElementById('active-count-' + gardenId).textContent = result.data.active;
                    document.getElementById('reserve-count-' + gardenId).textContent = result.data.reserve;

                    // Update cell styling
                    var cell = checkbox.closest('.sub-bed-cell');
                    var statusSpan = cell.querySelector('.sub-bed-status');
                    if (checkbox.checked) {
                        cell.classList.add('is-reserve');
                        statusSpan.textContent = 'R';
                    } else {
                        cell.classList.remove('is-reserve');
                        statusSpan.textContent = 'A';
                    }
                } else {
                    alert('Erreur: ' + (result.data.error || 'Inconnue'));
                    checkbox.checked = !checkbox.checked;
                }
            })
            .catch(function (err) {
                alert('Erreur de connexion: ' + err.message);
                checkbox.checked = !checkbox.checked;
            });
    }

    // ========================================
    // Rotation: Move up/down
    // ========================================
    function moveRotation(button, direction) {
        var item = button.closest('.rotation-item');
        var list = document.getElementById('rotationList');
        var items = Array.from(list.querySelectorAll('.rotation-item'));
        var index = items.indexOf(item);

        if (direction === -1 && index > 0) {
            list.insertBefore(item, items[index - 1]);
        } else if (direction === 1 && index < items.length - 1) {
            list.insertBefore(items[index + 1], item);
        }

        // Re-number positions and update arrows
        updateRotationDisplay();
    }

    function updateRotationDisplay() {
        var list = document.getElementById('rotationList');
        var items = Array.from(list.querySelectorAll('.rotation-item'));

        items.forEach(function (item, i) {
            item.querySelector('.rotation-position').textContent = i + 1;
            var arrows = item.querySelectorAll('.rotation-arrows .btn');
            arrows[0].disabled = (i === 0);
            arrows[1].disabled = (i === items.length - 1);
        });

        // Update preview
        var previewChain = document.getElementById('rotationPreviewChain');
        var html = '';
        items.forEach(function (item, i) {
            var cat = item.getAttribute('data-category');
            html += '<span class="cat-badge cat-' + cat.toLowerCase() + '">' + cat + '</span>';
            if (i < items.length - 1) {
                html += '<span class="rotation-arrow">‚Üí</span>';
            }
        });
        var firstCat = items[0].getAttribute('data-category');
        html += '<span class="rotation-arrow">‚Üí</span>';
        html += '<span class="rotation-wrap">(retour √† ' + firstCat + ')</span>';
        previewChain.innerHTML = html;
    }

    // ========================================
    // Cycles: Preview
    // ========================================
    function updateCyclePreview() {
        var select = document.getElementById('cyclesSelect');
        var val = select.value;
        var preview = document.getElementById('cyclePreviewExamples');
        var year = new Date().getFullYear();

        var formats = {
            '1': [year.toString()],
            '2': [year + 'A', year + 'B'],
            '3': [year + 'A', year + 'B', year + 'C'],
            '4': [year + 'Q1', year + 'Q2', year + 'Q3', year + 'Q4'],
        };

        var examples = formats[val] || [];
        preview.innerHTML = examples.map(function (ex) {
            return '<span class="cycle-example">' + ex + '</span>';
        }).join('<span class="rotation-arrow">,</span> ');
    }

    // Initialize cycle preview on load
    updateCyclePreview();

    // ========================================
    // Cycle Deletion Logic
    // ========================================
    var gardenCyclesMap = {
        {% for g in garden_data %}
    "{{ g.garden.id }}": [{% for c in g.cycles %}"{{ c }}", {% endfor %}],
    {% endfor %}
    };

    function updateDeleteCycleOptions() {
        var gardenSelect = document.getElementById('deleteCycleGardenSelect');
        var cycleSelect = document.getElementById('deleteCycleSelect');
        var hiddenInput = document.getElementById('deleteCycleGardenId');
        var submitBtn = document.getElementById('deleteCycleBtn');

        var gardenId = gardenSelect.value;
        hiddenInput.value = gardenId;

        // Clear current options
        cycleSelect.innerHTML = '<option value="">-- Choisir un cycle --</option>';

        if (gardenId && gardenCyclesMap[gardenId] && gardenCyclesMap[gardenId].length > 0) {
            var cycles = gardenCyclesMap[gardenId];
            cycles.forEach(function (c) {
                var opt = document.createElement('option');
                opt.value = c;
                opt.text = c;
                cycleSelect.appendChild(opt);
            });
            cycleSelect.disabled = false;
            submitBtn.disabled = false;
        } else {
            cycleSelect.disabled = true;
            submitBtn.disabled = true;
            if (gardenId) {
                var opt = document.createElement('option');
                opt.text = "Aucun cycle trouv√©";
                cycleSelect.appendChild(opt);
            }
        }
    }

    // ========================================
    // Plant Database Functions
    // ========================================

    function toggleImportPlants() {
        var form = document.getElementById('plant-import-form');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function filterPlantsList() {
        var input = document.getElementById('plantSearchInput');
        var filter = input.value.toLowerCase();
        var table = document.getElementById('plantsTable');
        if (!table) return;

        var rows = table.querySelectorAll('tbody tr');
        rows.forEach(function(row) {
            var searchText = row.getAttribute('data-search-text') || '';
            if (searchText.indexOf(filter) > -1) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function checkPlantDuplicate(input) {
        var name = input.value.trim();
        var warning = document.getElementById('plant-dup-warning');
        if (!name) {
            warning.style.display = 'none';
            return;
        }

        fetch('{{ url_for("plant_db.check_dup") }}?name=' + encodeURIComponent(name))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success && data.duplicate) {
                    warning.textContent = data.info.message;
                    warning.style.display = 'block';
                } else {
                    warning.style.display = 'none';
                }
            })
            .catch(function() {
                warning.style.display = 'none';
            });
    }

    function editPlant(plantId) {
        var modal = document.getElementById('plantEditModal');
        var body = document.getElementById('plantEditModalBody');
        body.innerHTML = '<p class="text-center">Chargement...</p>';
        modal.style.display = 'flex';

        fetch('{{ url_for("plant_db.list_plants") }}' + plantId)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success && data.plant) {
                    renderPlantEditForm(data.plant);
                } else {
                    body.innerHTML = '<p class="text-danger">Erreur: ' + (data.error || 'Plante introuvable') + '</p>';
                }
            })
            .catch(function(err) {
                body.innerHTML = '<p class="text-danger">Erreur de chargement</p>';
            });
    }

    function renderPlantEditForm(plant) {
        var body = document.getElementById('plantEditModalBody');
        var categories = {{ categories|tojson }};

        var categoryOptions = '<option value="">‚Äî Aucune ‚Äî</option>';
        categories.forEach(function(cat) {
            var selected = plant.default_category === cat ? 'selected' : '';
            categoryOptions += '<option value="' + cat + '" ' + selected + '>' + cat + '</option>';
        });

        var commonNamesHtml = '';
        if (plant.common_names && plant.common_names.length > 0) {
            plant.common_names.forEach(function(cn) {
                var isPreferred = cn.is_preferred ? ' checked' : '';
                var preferredClass = cn.is_preferred ? ' preferred-name' : '';
                commonNamesHtml += '<div class="d-flex gap-sm align-center mb-sm' + preferredClass + '" data-cn-id="' + cn.id + '">' +
                    '<label class="sr-only" for="cn-name-' + cn.id + '">Nom commun</label>' +
                    '<input type="text" id="cn-name-' + cn.id + '" class="form-input form-input-sm" value="' + cn.name + '" style="flex:1">' +
                    '<label class="sr-only" for="cn-lang-' + cn.id + '">Langue</label>' +
                    '<select id="cn-lang-' + cn.id + '" class="form-select form-select-sm" style="width:80px">' +
                    '<option value="fr"' + (cn.lang === 'fr' ? ' selected' : '') + '>FR</option>' +
                    '<option value="en"' + (cn.lang === 'en' ? ' selected' : '') + '>EN</option>' +
                    '<option value="local"' + (cn.lang === 'local' ? ' selected' : '') + '>Local</option>' +
                    '</select>' +
                    '<button type="button" class="btn btn-sm ' + (cn.is_preferred ? 'btn-accent' : 'btn-secondary') + '" onclick="setPreferredName(' + cn.id + ', ' + plant.id + ')" title="D√©finir comme nom pr√©f√©r√©">‚≠ê</button>' +
                    '<button type="button" class="btn btn-sm btn-danger" onclick="deleteCommonName(' + cn.id + ', this)">üóëÔ∏è</button>' +
                    '</div>';
            });
        }

        var synonymsHtml = '';
        if (plant.synonyms && plant.synonyms.length > 0) {
            plant.synonyms.forEach(function(syn) {
                synonymsHtml += '<div class="d-flex gap-sm align-center mb-sm" data-syn-id="' + syn.id + '">' +
                    '<label class="sr-only" for="syn-name-' + syn.id + '">Synonyme</label>' +
                    '<input type="text" id="syn-name-' + syn.id + '" class="form-input form-input-sm" value="' + syn.synonym + '" style="flex:1">' +
                    '<button type="button" class="btn btn-sm btn-danger" onclick="deleteSynonym(' + syn.id + ', this)">üóëÔ∏è</button>' +
                    '</div>';
            });
        }

        body.innerHTML = '<form id="editPlantForm" onsubmit="submitPlantEdit(event, ' + plant.id + ')">' +
            '<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">' +
            '<div class="form-group">' +
            '<label class="form-label" for="edit-plant-scientific">Nom scientifique</label>' +
            '<input type="text" name="scientific_name" id="edit-plant-scientific" class="form-input" value="' + plant.scientific_name + '" required>' +
            '</div>' +
            '<div class="form-row form-row-2 mt-md">' +
            '<div class="form-group">' +
            '<label class="form-label" for="edit-plant-family">Famille botanique</label>' +
            '<input type="text" name="family" id="edit-plant-family" class="form-input" value="' + (plant.family || '') + '" autocomplete="off">' +
            '</div>' +
            '<div class="form-group">' +
            '<label class="form-label" for="edit-plant-category">Cat√©gorie par d√©faut</label>' +
            '<select name="default_category" id="edit-plant-category" class="form-select">' + categoryOptions + '</select>' +
            '</div>' +
            '</div>' +
            '<div class="mt-lg">' +
            '<h4>Noms communs</h4>' +
            '<div id="commonNamesList">' + commonNamesHtml + '</div>' +
            '<div class="d-flex gap-sm mt-sm">' +
            '<label class="sr-only" for="newCommonName">Nouveau nom commun</label>' +
            '<input type="text" id="newCommonName" class="form-input form-input-sm" placeholder="Nouveau nom commun" style="flex:1">' +
            '<label class="sr-only" for="newCommonNameLang">Langue</label>' +
            '<select id="newCommonNameLang" class="form-select form-select-sm" style="width:80px">' +
            '<option value="fr">FR</option><option value="en">EN</option><option value="local">Local</option>' +
            '</select>' +
            '<button type="button" class="btn btn-sm btn-secondary" onclick="addCommonName(' + plant.id + ')">‚ûï</button>' +
            '</div>' +
            '</div>' +
            '<div class="mt-lg">' +
            '<h4>Synonymes</h4>' +
            '<div id="synonymsList">' + synonymsHtml + '</div>' +
            '<div class="d-flex gap-sm mt-sm">' +
            '<label class="sr-only" for="newSynonym">Nouveau synonyme</label>' +
            '<input type="text" id="newSynonym" class="form-input form-input-sm" placeholder="Nouveau synonyme" style="flex:1">' +
            '<button type="button" class="btn btn-sm btn-secondary" onclick="addSynonym(' + plant.id + ')">‚ûï</button>' +
            '</div>' +
            '</div>' +
            '<div class="mt-lg d-flex gap-sm">' +
            '<button type="submit" class="btn btn-primary">Enregistrer</button>' +
            '<button type="button" class="btn btn-secondary" onclick="closePlantModal()">Annuler</button>' +
            '</div>' +
            '</form>';
    }

    function closePlantModal() {
        document.getElementById('plantEditModal').style.display = 'none';
    }

    function submitPlantEdit(event, plantId) {
        event.preventDefault();
        var form = document.getElementById('editPlantForm');
        var formData = new FormData(form);
        formData.append('plant_id', plantId);

        fetch('{{ url_for("plant_db.edit_plant") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                closePlantModal();
                location.reload();
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(function() {
            alert('Erreur de connexion');
        });
    }

    function addCommonName(plantId) {
        var nameInput = document.getElementById('newCommonName');
        var langSelect = document.getElementById('newCommonNameLang');
        var name = nameInput.value.trim();
        var lang = langSelect.value;

        if (!name) {
            alert('Veuillez entrer un nom commun');
            return;
        }

        var formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('plant_id', plantId);
        formData.append('name', name);
        formData.append('lang', lang);

        fetch('{{ url_for("plant_db.add_cn") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                nameInput.value = '';
                // Reload the modal content
                editPlant(plantId);
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(function() {
            alert('Erreur de connexion');
        });
    }

    function deleteCommonName(cnId, btn) {
        if (!confirm('Supprimer ce nom commun ?')) return;

        var formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('common_name_id', cnId);

        fetch('{{ url_for("plant_db.remove_cn") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                btn.closest('[data-cn-id]').remove();
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(function() {
            alert('Erreur de connexion');
        });
    }

    function setPreferredName(cnId, plantId) {
        var formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('common_name_id', cnId);

        fetch('{{ url_for("plant_db.set_preferred") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                // Reload the modal to show updated preferred name
                editPlant(plantId);
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(function() {
            alert('Erreur de connexion');
        });
    }

    function addSynonym(plantId) {
        var synInput = document.getElementById('newSynonym');
        var synonym = synInput.value.trim();

        if (!synonym) {
            alert('Veuillez entrer un synonyme');
            return;
        }

        var formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('plant_id', plantId);
        formData.append('synonym', synonym);

        fetch('{{ url_for("plant_db.add_syn") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                synInput.value = '';
                // Reload the modal content
                editPlant(plantId);
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(function() {
            alert('Erreur de connexion');
        });
    }

    function deleteSynonym(synId, btn) {
        if (!confirm('Supprimer ce synonyme ?')) return;

        var formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('synonym_id', synId);

        fetch('{{ url_for("plant_db.remove_syn") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                btn.closest('[data-syn-id]').remove();
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(function() {
            alert('Erreur de connexion');
        });
    }

    // ========================================
    // Add Plant to Crops
    // ========================================

    function addPlantToCrops(plantId) {
        if (!confirm('Ajouter cette plante aux cultures actives ?')) return;

        var formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('plant_id', plantId);

        fetch('{{ url_for("plant_db.add_to_crops") }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('‚úì ' + data.message);
                // Optionally reload to update the Cultures tab
                location.reload();
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(function() {
            alert('Erreur de connexion');
        });
    }

    // ========================================
    // Crop Autofill from Plant Database
    // ========================================

    var searchTimeout = null;
    var currentSuggestions = [];
    var selectedSuggestionIndex = -1;

    function searchPlantSuggestions(query) {
        var dropdown = document.getElementById('cropSuggestions');

        if (!query || query.length < 2) {
            dropdown.style.display = 'none';
            currentSuggestions = [];
            return;
        }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            fetch('{{ url_for("plant_db.suggestions") }}?q=' + encodeURIComponent(query) + '&limit=8')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.suggestions && data.suggestions.length > 0) {
                        currentSuggestions = data.suggestions;
                        renderSuggestions(data.suggestions);
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.style.display = 'none';
                        currentSuggestions = [];
                    }
                })
                .catch(function() {
                    dropdown.style.display = 'none';
                    currentSuggestions = [];
                });
        }, 200);
    }

    function renderSuggestions(suggestions) {
        var dropdown = document.getElementById('cropSuggestions');
        var html = '';

        suggestions.forEach(function(s, index) {
            var mainName = s.preferred_name || s.scientific_name;
            var matchInfo = '';
            if (s.match_type === 'common_name') {
                matchInfo = '<div class="autocomplete-match">Trouv√© via: ' + s.display_name + '</div>';
            } else if (s.match_type === 'synonym') {
                matchInfo = '<div class="autocomplete-match">Synonyme: ' + s.display_name + '</div>';
            }

            html += '<div class="autocomplete-item" data-index="' + index + '" onclick="selectPlantSuggestion(' + index + ')">' +
                '<div class="autocomplete-main">' + mainName + '</div>' +
                '<div class="autocomplete-sub">' +
                (s.preferred_name ? '<em>' + s.scientific_name + '</em> ‚Ä¢ ' : '') +
                (s.family ? s.family : 'Famille inconnue') +
                (s.default_category ? ' ‚Ä¢ ' + s.default_category : '') +
                '</div>' +
                matchInfo +
                '</div>';
        });

        dropdown.innerHTML = html;
        selectedSuggestionIndex = -1;
    }

    function selectPlantSuggestion(index) {
        var s = currentSuggestions[index];
        if (!s) return;

        // Fill in the form fields - use preferred_name if available
        document.getElementById('cropNameInput').value = s.preferred_name || s.display_name || s.scientific_name;
        document.getElementById('cropPlantId').value = s.plant_id;

        if (s.family) {
            document.getElementById('cropFamilyInput').value = s.family;
        }

        if (s.default_category) {
            var categorySelect = document.getElementById('cropCategorySelect');
            for (var i = 0; i < categorySelect.options.length; i++) {
                if (categorySelect.options[i].value === s.default_category) {
                    categorySelect.selectedIndex = i;
                    break;
                }
            }
        }

        // Show link info with preferred name and scientific name
        var linkInfo = document.getElementById('plantLinkInfo');
        var displayText = s.preferred_name
            ? s.preferred_name + ' (<em>' + s.scientific_name + '</em>)'
            : s.scientific_name;
        linkInfo.innerHTML = '‚úì Li√© √† la plante: <strong>' + displayText + '</strong>';
        linkInfo.style.display = 'block';

        // Hide dropdown
        document.getElementById('cropSuggestions').style.display = 'none';
        currentSuggestions = [];
    }

    // Handle keyboard navigation in suggestions
    document.getElementById('cropNameInput').addEventListener('keydown', function(e) {
        var dropdown = document.getElementById('cropSuggestions');
        if (dropdown.style.display === 'none' || currentSuggestions.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
            updateSelectedSuggestion();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, 0);
            updateSelectedSuggestion();
        } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
            e.preventDefault();
            selectPlantSuggestion(selectedSuggestionIndex);
        } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
            currentSuggestions = [];
        }
    });

    function updateSelectedSuggestion() {
        var items = document.querySelectorAll('#cropSuggestions .autocomplete-item');
        items.forEach(function(item, i) {
            if (i === selectedSuggestionIndex) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        var dropdown = document.getElementById('cropSuggestions');
        var input = document.getElementById('cropNameInput');
        if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
            dropdown.style.display = 'none';
        }
    });

    // Clear plant_id if user manually types a different name
    document.getElementById('cropNameInput').addEventListener('input', function() {
        document.getElementById('cropPlantId').value = '';
        document.getElementById('plantLinkInfo').style.display = 'none';
    });
</script>
{% endblock %}