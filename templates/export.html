{% extends "base.html" %}

{% block title %}{{ i18n.nav.export }} ‚Äî {{ i18n.nav.app_title }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üì§ {{ i18n.nav.export }}</h1>
    <p class="page-subtitle">Exporter les donn√©es des cycles et des jardins</p>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">üìä Exporter vers Excel</h2>
    </div>
    <div class="card-body">
        <p class="mb-lg">
            T√©l√©chargez les donn√©es de planification et de r√©colte au format Excel (.xlsx).
            Le fichier inclut une feuille pour le plan et une feuille pour la r√©partition.
        </p>

        <form method="GET" action="" id="exportForm" class="form-row align-end">
            <div class="form-group">
                <label class="form-label">{{ i18n.labels.garden }}</label>
                <select id="gardenSelect" class="form-select">
                    <option value="all">Tous les jardins (Fichier multi-onglets)</option>
                    {% for g in gardens %}
                    <option value="{{ g.id }}">{{ g.garden_code }} ‚Äî {{ g.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">{{ i18n.labels.cycle }}</label>
                <select id="cycleSelect" class="form-select">
                    {% for c in cycles %}
                    <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="submitExport()">
                    <span class="btn-icon">üì•</span> T√©l√©charger
                </button>
            </div>
        </form>

        <div class="mt-lg text-muted text-sm">
            <p>‚ÑπÔ∏è <strong>Note :</strong> Une sauvegarde automatique est cr√©√©e avant chaque export.</p>
        </div>
    </div>
</div>

<script>
    function submitExport() {
        var gardenId = document.getElementById('gardenSelect').value;
        var cycle = document.getElementById('cycleSelect').value;

        if (!cycle) {
            alert("Veuillez s√©lectionner un cycle.");
            return;
        }

        var url;
        if (gardenId === 'all') {
            url = "{{ url_for('export.export_excel_all', cycle='CYCLE_PLACEHOLDER') }}";
            url = url.replace('CYCLE_PLACEHOLDER', cycle);
        } else {
            url = "{{ url_for('export.export_excel', garden_id=0, cycle='CYCLE_PLACEHOLDER') }}";
            url = url.replace('/0/', '/' + gardenId + '/').replace('CYCLE_PLACEHOLDER', cycle);
        }

        window.location.href = url;
    }
</script>
{% endblock %}