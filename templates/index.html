{% extends "base.html" %}

{% block title %}{{ i18n.pages.home_title }} â€” {{ i18n.nav.app_title }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">{{ i18n.pages.home_title }}</h1>
    <p class="page-subtitle">Gestion de la rotation des cultures pour le maraÃ®chage</p>
</div>

<!-- Garden & Cycle Selectors -->
<div class="card selector-card">
    <div class="card-body">
        <form method="get" action="{{ url_for('main.index') }}" class="selector-form" id="selectorForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="garden_id" class="form-label">
                        <span class="label-icon">ğŸŒ¿</span> {{ i18n.labels.select_garden }}
                    </label>
                    <select name="garden_id" id="garden_id" class="form-select"
                        onchange="document.getElementById('selectorForm').submit()">
                        {% for garden in gardens %}
                        <option value="{{ garden.id }}" {% if garden.id==selected_garden_id %}selected{% endif %}>
                            {{ garden.garden_code }} â€” {{ garden.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="cycle" class="form-label">
                        <span class="label-icon">ğŸ”„</span> {{ i18n.labels.select_cycle }}
                    </label>
                    <select name="cycle" id="cycle" class="form-select">
                        {% if cycles %}
                        {% for cycle in cycles %}
                        <option value="{{ cycle }}" {% if cycle==selected_cycle %}selected{% endif %}>
                            {{ cycle }}
                        </option>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled selected>{{ i18n.labels.no_cycle }}</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Cycle State Indicators -->
{% if cycle_state and has_cycles %}
<div class="card status-card">
    <div class="card-header">
        <h2 class="card-title">ğŸ“‹ Ã‰tat du cycle {{ selected_cycle }}</h2>
    </div>
    <div class="card-body">
        <div class="status-indicators">
            <div class="status-item {% if cycle_state.has_plans %}status-ok{% else %}status-missing{% endif %}">
                <span class="status-icon">{% if cycle_state.has_plans %}âœ…{% else %}â¬œ{% endif %}</span>
                <span class="status-label">Plan de rotation</span>
            </div>
            <div class="status-item {% if cycle_state.has_actual_data %}status-ok{% else %}status-missing{% endif %}">
                <span class="status-icon">{% if cycle_state.has_actual_data %}âœ…{% else %}â¬œ{% endif %}</span>
                <span class="status-label">DonnÃ©es rÃ©elles</span>
            </div>
            <div class="status-item {% if cycle_state.has_distribution %}status-ok{% else %}status-missing{% endif %}">
                <span class="status-icon">{% if cycle_state.has_distribution %}âœ…{% else %}â¬œ{% endif %}</span>
                <span class="status-label">RÃ©partition</span>
            </div>
            <div
                class="status-item {% if cycle_state.has_crop_assignments %}status-ok{% else %}status-missing{% endif %}">
                <span class="status-icon">{% if cycle_state.has_crop_assignments %}âœ…{% else %}â¬œ{% endif %}</span>
                <span class="status-label">Cultures affectÃ©es</span>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="card actions-card">
    <div class="card-header">
        <h2 class="card-title">Actions</h2>
    </div>
    <div class="card-body">
        <div class="action-buttons">
            {% if has_cycles %}
            <a href="{{ url_for('cycle.bootstrap', garden_id=selected_garden_id) }}"
               class="btn btn-primary btn-lg"
               onclick="return confirm('âš ï¸ Attention : Ce jardin a dÃ©jÃ  des cycles existants.\n\nLe dÃ©marrage Ã  zÃ©ro Ã©crasera les donnÃ©es du cycle que vous saisirez.\n\nÃŠtes-vous sÃ»r de vouloir continuer ?');">
                <span class="btn-icon">ğŸš€</span>
                {{ i18n.buttons.bootstrap }}
            </a>
            {% else %}
            <a href="{{ url_for('cycle.bootstrap', garden_id=selected_garden_id) }}" class="btn btn-primary btn-lg">
                <span class="btn-icon">ğŸš€</span>
                {{ i18n.buttons.bootstrap }}
            </a>
            {% endif %}
            <a href="{% if has_cycles %}{{ url_for('main.map_view', garden_id=selected_garden_id, cycle=selected_cycle) }}{% else %}#{% endif %}"
                class="btn btn-secondary btn-lg {% if not has_cycles %}btn-disabled{% endif %}" {% if not has_cycles
                %}aria-disabled="true" tabindex="-1" {% endif %}>
                <span class="btn-icon">ğŸ—ºï¸</span>
                {{ i18n.buttons.view_map }}
            </a>

            {% set can_generate = has_cycles and cycle_state and cycle_state.has_actual_data %}
            <form method="post" action="{{ url_for('cycle.generate_cycle', garden_id=selected_garden_id) }}"
                style="display: inline;"
                onsubmit="return confirm('GÃ©nÃ©rer le prochain cycle pour ce jardin ? Une sauvegarde automatique sera crÃ©Ã©e.');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-accent btn-lg {% if not can_generate %}btn-disabled{% endif %}" {%
                    if not can_generate %}disabled{% endif %}>
                    <span class="btn-icon">âš¡</span>
                    {{ i18n.buttons.generate_next }}
                </button>
            </form>

            {% if has_cycles and cycle_state and cycle_state.has_plans and not cycle_state.has_distribution and not cycle_state.has_crop_assignments %}
            <a href="{{ url_for('distribution.distribution_page', garden_id=selected_garden_id, cycle=selected_cycle) }}"
                class="btn btn-primary btn-lg">
                <span class="btn-icon">ğŸ“Š</span>
                Ajuster la rÃ©partition
            </a>
            {% endif %}

            {% if has_cycles %}
            <a href="{{ url_for('export.export_excel', garden_id=selected_garden_id, cycle=selected_cycle) }}"
                class="btn btn-secondary btn-lg">
                <span class="btn-icon">ğŸ“¥</span>
                {{ i18n.buttons.export_excel }}
            </a>
            <a href="{{ url_for('export.export_excel_all', cycle=selected_cycle) }}" class="btn btn-secondary btn-lg">
                <span class="btn-icon">ğŸ“¦</span>
                Exporter tous les jardins
            </a>
            {% endif %}
        </div>

        {% if has_cycles and not can_generate %}
        <p class="action-hint">ğŸ’¡ La gÃ©nÃ©ration du prochain cycle nÃ©cessite des donnÃ©es rÃ©elles (catÃ©gories et cultures
            effectives) dans le cycle actuel.</p>
        {% endif %}

        {% if last_backup %}
        <p class="action-hint" style="margin-top: var(--spacing-sm);">
            ğŸ’¾ DerniÃ¨re sauvegarde : {{ last_backup.timestamp }} ({{ last_backup.reason }})
        </p>
        {% endif %}
    </div>
</div>

<!-- Garden Statistics -->
{% if stats %}
<div class="card stats-card">
    <div class="card-header">
        <h2 class="card-title">
            ğŸ“Š {{ stats.garden.garden_code }} â€” {{ stats.garden.name }}
        </h2>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-value">{{ stats.beds }}</span>
                <span class="stat-label">{{ i18n.stats.beds }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ stats.total_sub_beds }}</span>
                <span class="stat-label">{{ i18n.stats.sub_beds }}</span>
            </div>
            <div class="stat-item stat-active">
                <span class="stat-value">{{ stats.active_sub_beds }}</span>
                <span class="stat-label">{{ i18n.stats.active }}</span>
            </div>
            <div class="stat-item stat-reserve">
                <span class="stat-value">{{ stats.reserve_sub_beds }}</span>
                <span class="stat-label">{{ i18n.stats.reserve }}</span>
            </div>
        </div>

        <div class="garden-meta">
            <span class="meta-item">ğŸ“ {{ stats.garden.bed_length_m }}m Ã— {{ stats.garden.bed_width_m }}m</span>
            <span class="meta-item">ğŸ”² {{ stats.garden.sub_beds_per_bed }} {{ i18n.stats.sub_beds }}/{{
                i18n.glossary.bed | lower }}</span>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}