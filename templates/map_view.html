{% extends "base.html" %}

{% block title %}Carte ‚Äî {{ garden['name'] }} ‚Äî Cycle {{ cycle }}{% endblock %}

{% block content %}
<div class="map-page">

    {# ‚îÄ‚îÄ Page Header ‚îÄ‚îÄ #}
    <div class="map-header">
        <div class="map-nav">
            {% if prev_cycle %}
            <a href="{{ url_for('main.map_view', garden_id=garden['id'], cycle=prev_cycle) }}"
                class="btn btn-outline btn-sm" title="Cycle pr√©c√©dent">
                ‚Üê {{ prev_cycle }}
            </a>
            {% else %}
            <span class="btn btn-outline btn-sm btn-disabled">‚Üê Pr√©c√©dent</span>
            {% endif %}

            <h1 class="map-title">
                {{ garden['name'] }} ‚Äî Cycle {{ cycle }}
            </h1>

            {% if next_cycle %}
            <a href="{{ url_for('main.map_view', garden_id=garden['id'], cycle=next_cycle) }}"
                class="btn btn-outline btn-sm" title="Cycle suivant">
                {{ next_cycle }} ‚Üí
            </a>
            {% else %}
            <span class="btn btn-outline btn-sm btn-disabled">Suivant ‚Üí</span>
            {% endif %}
        </div>

        {# ‚îÄ‚îÄ Action Toolbar ‚îÄ‚îÄ #}
        <div class="map-toolbar no-print">
            <a href="{{ url_for('export.export_excel', garden_id=garden['id'], cycle=cycle) }}"
                class="btn btn-secondary btn-sm">
                üì• Exporter (Excel)
            </a>
            <a href="{{ url_for('main.print_view', garden_id=garden['id'], cycle=cycle) }}"
                class="btn btn-secondary btn-sm" target="_blank">
                üñ®Ô∏è Imprimer
            </a>
            <form method="POST" action="{{ url_for('cycle.finalize_cycle', garden_id=garden['id'], cycle=cycle) }}"
                style="display: inline;"
                onsubmit="return confirm('Finaliser ce cycle ? Un instantan√© sera sauvegard√© dans l\'historique.');">
                <button type="submit" class="btn btn-accent btn-sm">
                    ‚úÖ Finaliser le cycle
                </button>
            </form>
            <form method="POST" action="{{ url_for('cycle.undo_cycle', garden_id=garden['id']) }}"
                style="display: inline;"
                onsubmit="return confirm('√ätes-vous s√ªr de vouloir annuler la g√©n√©ration du cycle {{ cycle }} ?{% if has_overrides %} Des remplacements ont √©t√© enregistr√©s et seront perdus.{% endif %}');">
                <button type="submit" class="btn btn-danger btn-sm">
                    ‚ö†Ô∏è Annuler la g√©n√©ration
                </button>
            </form>
            <a href="{{ url_for('main.index', garden_id=garden['id'], cycle=cycle) }}" class="btn btn-outline btn-sm">
                ‚Üê Accueil
            </a>
        </div>
    </div>

    {# ‚îÄ‚îÄ Legend ‚îÄ‚îÄ #}
    <div class="map-legend">
        <span class="map-legend-title">L√©gende :</span>
        <div class="map-legend-items">
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-feuille"></span>
                <span>Feuille</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-graine"></span>
                <span>Graine</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-racine"></span>
                <span>Racine</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-fruit"></span>
                <span>Fruit</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-couverture"></span>
                <span>Couverture</span>
            </div>
        </div>
    </div>

    {# ‚îÄ‚îÄ Map Table ‚îÄ‚îÄ #}
    <div class="map-container">
        <table class="map-table" id="mapTable">
            <thead>
                <tr>
                    <th class="map-bed-header">Planche</th>
                    {% for i in range(1, sub_beds_per_bed + 1) %}
                    <th class="map-sub-header">S{{ i }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for bed in map_data['beds'] %}
                <tr>
                    <td class="map-bed-label">P{{ bed['bed_number'] }}</td>
                    {% for sb in bed['sub_beds'] %}
                    {% set display_cat = sb['actual_category'] or sb['planned_category'] %}
                    {% set display_crop = sb['actual_crop_name'] or sb['planned_crop_name'] %}
                    {% set cat_class = 'cat-' + (display_cat|lower if display_cat else 'empty') %}
                    {% set is_diff = sb['actual_crop_name'] and sb['actual_crop_name'] != sb['planned_crop_name'] %}
                    <td class="map-cell {{ cat_class }}{% if sb['is_override'] %} map-cell-overridden{% endif %}"
                        id="subbed-{{ bed['bed_number'] }}-{{ sb['position'] }}"
                        data-plan-id="{{ sb['cycle_plan_id'] }}" data-bed="{{ bed['bed_number'] }}"
                        data-position="{{ sb['position'] }}" data-planned-category="{{ sb['planned_category'] or '' }}"
                        data-planned-crop="{{ sb['planned_crop_name'] or '' }}"
                        data-actual-category="{{ sb['actual_category'] or '' }}"
                        data-actual-crop-id="{{ sb['actual_crop_id'] or '' }}"
                        data-actual-crop="{{ sb['actual_crop_name'] or '' }}" data-notes="{{ sb['notes'] or '' }}" {% if
                        is_diff %}
                        title="Planifi√©: {{ sb['planned_crop_name'] or sb['planned_category'] }} / R√©el: {{ sb['actual_crop_name'] or sb['actual_category'] }}"
                        {% endif %}>
                        {% if sb['is_override'] %}
                        <span class="map-override-icon" title="Remplac√©">‚úèÔ∏è</span>
                        {% endif %}
                        <span class="map-cell-crop">{{ display_crop or display_cat or '‚Äî' }}</span>
                        {% if is_diff %}
                        <span class="map-cell-planned">{{ sb['planned_crop_name'] or sb['planned_category'] }}</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# ‚îÄ‚îÄ Reserve Beds ‚îÄ‚îÄ #}
    {% if map_data['reserve_beds'] %}
    <div class="reserve-section">
        <h3 class="reserve-title">üåø Sous-Planches de r√©serve</h3>
        <div class="reserve-beds">
            {% for rb in map_data['reserve_beds'] %}
            <div class="reserve-bed-chip">
                P{{ rb['bed_number'] }}-S{{ rb['sub_bed_position'] }}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

{# ‚îÄ‚îÄ Override Modal ‚îÄ‚îÄ #}
<div class="modal-overlay" id="overrideModal" style="display:none;">
    <div class="modal-content">
        <h3 class="modal-title">‚úèÔ∏è Remplacement</h3>
        <form method="POST" action="{{ url_for('main.map_override', garden_id=garden['id'], cycle=cycle) }}"
            id="overrideForm">

            <div class="modal-info">
                <strong>Planche :</strong> <span id="modalBedInfo">‚Äî</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="modalPlanned">Planifi√©</label>
                <input type="text" class="form-input" id="modalPlanned" readonly>
            </div>

            <input type="hidden" name="plan_id" id="modalPlanId">
            <input type="hidden" name="bed_number" id="modalBedNum">
            <input type="hidden" name="sub_bed_position" id="modalSubBedPos">

            <div class="form-group">
                <label class="form-label" for="modalCategory">Cat√©gorie r√©elle</label>
                <select class="form-select" name="actual_category" id="modalCategory" required>
                    <option value="">‚Äî Choisir ‚Äî</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="modalCrop">Culture r√©elle</label>
                <select class="form-select" name="actual_crop_id" id="modalCrop">
                    <option value="">‚Äî Choisir ‚Äî</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="modalNotes">Notes</label>
                <input type="text" class="form-input" name="notes" id="modalNotes"
                    placeholder="Raison du remplacement...">
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-outline" id="modalCancel">Annuler</button>
            </div>
        </form>
    </div>
</div>

{# Crops data for JS filtering #}
<script>
    window.cropsByCategory = {{ crops_by_category | tojson }};
</script>
{% endblock %}