{% extends "base.html" %}

{% block title %}Carte â€” {{ garden['name'] }} â€” Cycle {{ cycle }}{% endblock %}

{% block content %}
<div class="map-page">

    {# â”€â”€ Page Header â”€â”€ #}
    <div class="map-header">
        <div class="map-nav">
            {% if prev_cycle %}
            <a href="{{ url_for('main.map_view', garden_id=garden['id'], cycle=prev_cycle) }}"
                class="btn btn-outline btn-sm" title="Cycle prÃ©cÃ©dent">
                â† {{ prev_cycle }}
            </a>
            {% else %}
            <span class="btn btn-outline btn-sm btn-disabled">â† PrÃ©cÃ©dent</span>
            {% endif %}

            <h1 class="map-title">
                {{ garden['name'] }} â€” Cycle {{ cycle }}
            </h1>

            {% if next_cycle %}
            <a href="{{ url_for('main.map_view', garden_id=garden['id'], cycle=next_cycle) }}"
                class="btn btn-outline btn-sm" title="Cycle suivant">
                {{ next_cycle }} â†’
            </a>
            {% else %}
            <span class="btn btn-outline btn-sm btn-disabled">Suivant â†’</span>
            {% endif %}
        </div>

        {# â”€â”€ Action Toolbar â”€â”€ #}
        <div class="map-toolbar no-print">
            <a href="{{ url_for('export.export_excel', garden_id=garden['id'], cycle=cycle) }}"
                class="btn btn-secondary btn-sm">
                ğŸ“¥ Exporter (Excel)
            </a>
            <a href="{{ url_for('main.print_view', garden_id=garden['id'], cycle=cycle) }}"
                class="btn btn-secondary btn-sm" target="_blank">
                ğŸ–¨ï¸ Imprimer
            </a>
            <form method="POST" action="{{ url_for('cycle.finalize_cycle', garden_id=garden['id'], cycle=cycle) }}"
                style="display: inline;"
                onsubmit="return confirm('Finaliser ce cycle ? Un instantanÃ© sera sauvegardÃ© dans l\'historique.');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-accent btn-sm">
                    âœ… Finaliser le cycle
                </button>
            </form>
            <form method="POST" action="{{ url_for('cycle.undo_cycle', garden_id=garden['id']) }}"
                style="display: inline;"
                onsubmit="return confirm('ÃŠtes-vous sÃ»r de vouloir annuler la gÃ©nÃ©ration du cycle {{ cycle }} ?{% if has_overrides %} Des remplacements ont Ã©tÃ© enregistrÃ©s et seront perdus.{% endif %}');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger btn-sm">
                    âš ï¸ Annuler la gÃ©nÃ©ration
                </button>
            </form>
            <a href="{{ url_for('main.index', garden_id=garden['id'], cycle=cycle) }}" class="btn btn-outline btn-sm">
                â† Accueil
            </a>
        </div>
    </div>

    {# â”€â”€ Legend â”€â”€ #}
    <div class="map-legend">
        <span class="map-legend-title">LÃ©gende :</span>
        <div class="map-legend-items">
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-feuille"></span>
                <span>Feuille</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-graine"></span>
                <span>Graine</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-racine"></span>
                <span>Racine</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-fruit"></span>
                <span>Fruit</span>
            </div>
            <div class="map-legend-item">
                <span class="map-legend-swatch cat-couverture"></span>
                <span>Couverture</span>
            </div>
        </div>
    </div>

    {# â”€â”€ Map Table â”€â”€ #}
    <div class="map-container">
        <table class="map-table" id="mapTable">
            <thead>
                <tr>
                    <th class="map-bed-header">Planche</th>
                    {% for i in range(1, sub_beds_per_bed + 1) %}
                    <th class="map-sub-header">S{{ i }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for bed in map_data['beds'] %}
                <tr>
                    <td class="map-bed-label">P{{ bed['bed_number'] }}</td>
                    {% for sb in bed['sub_beds'] %}
                    {% set display_cat = sb['actual_category'] or sb['planned_category'] %}
                    {% set display_crop = sb['actual_crop_name'] or sb['planned_crop_name'] %}
                    {% set cat_class = 'cat-' + (display_cat|lower if display_cat else 'empty') %}
                    {% set is_diff = sb['actual_crop_name'] and sb['actual_crop_name'] != sb['planned_crop_name'] %}
                    <td class="map-cell {{ cat_class }}{% if sb['is_override'] %} map-cell-overridden{% endif %}"
                        id="subbed-{{ bed['bed_number'] }}-{{ sb['position'] }}"
                        data-plan-id="{{ sb['cycle_plan_id'] }}" data-bed="{{ bed['bed_number'] }}"
                        data-position="{{ sb['position'] }}" data-planned-category="{{ sb['planned_category'] or '' }}"
                        data-planned-crop="{{ sb['planned_crop_name'] or '' }}"
                        data-actual-category="{{ sb['actual_category'] or '' }}"
                        data-actual-crop-id="{{ sb['actual_crop_id'] or '' }}"
                        data-actual-crop="{{ sb['actual_crop_name'] or '' }}" data-notes="{{ sb['notes'] or '' }}" {% if
                        is_diff %}
                        title="PlanifiÃ©: {{ sb['planned_crop_name'] or sb['planned_category'] }} / RÃ©el: {{ sb['actual_crop_name'] or sb['actual_category'] }}"
                        {% endif %}>
                        {% if sb['is_override'] %}
                        <span class="map-override-icon" title="RemplacÃ©">âœï¸</span>
                        {% endif %}
                        <span class="map-cell-crop">{{ display_crop or display_cat or 'â€”' }}</span>
                        {% if is_diff %}
                        <span class="map-cell-planned">{{ sb['planned_crop_name'] or sb['planned_category'] }}</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# â”€â”€ Map Statistics â”€â”€ #}
    {% set cat_icons = {'Feuille': 'ğŸŒ¿', 'Graine': 'ğŸŒ»', 'Racine': 'ğŸ«š', 'Fruit': 'ğŸ', 'Couverture': 'ğŸª»'} %}
    <div class="map-stats-section">
        <h3 class="map-stats-title">Distribution des sous-planches</h3>
        {# Crop counts by category #}
        {% for cat, crops in map_data['crop_stats'].items() %}
        {% if crops %}
        <div class="map-stats-row">
            <span class="map-stats-label cat-label-{{ cat|lower }}">{{ cat_icons[cat] }} <strong>{{ cat }}</strong> :</span>
            <div class="map-stats-crops">
                {% for crop_name, count in crops.items() %}
                <span class="map-stats-crop">{{ crop_name }} <strong>{{ count }}</strong></span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endfor %}

        {# Reserve sub-beds (last) #}
        {% if map_data['reserve_beds'] %}
        <div class="map-stats-row reserve-row">
            <span class="map-stats-label">ğŸª§ <strong>Sous-planches de rÃ©serve</strong> :</span>
            <div class="map-stats-chips">
                {% for rb in map_data['reserve_beds'] %}
                <span class="map-stats-chip">P{{ rb['bed_number'] }}-S{{ rb['sub_bed_position'] }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{# â”€â”€ Override Modal â”€â”€ #}
<div class="modal-overlay" id="overrideModal" style="display:none;">
    <div class="modal-content">
        <h3 class="modal-title">âœï¸ Remplacement</h3>
        <form method="POST" action="{{ url_for('main.map_override', garden_id=garden['id'], cycle=cycle) }}"
            id="overrideForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="modal-info">
                <strong>Planche :</strong> <span id="modalBedInfo">â€”</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="modalPlanned">PlanifiÃ©</label>
                <input type="text" class="form-input" id="modalPlanned" readonly>
            </div>

            <input type="hidden" name="plan_id" id="modalPlanId">
            <input type="hidden" name="bed_number" id="modalBedNum">
            <input type="hidden" name="sub_bed_position" id="modalSubBedPos">

            <div class="form-group">
                <label class="form-label" for="modalCategory">CatÃ©gorie rÃ©elle</label>
                <select class="form-select" name="actual_category" id="modalCategory" required>
                    <option value="">â€” Choisir â€”</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="modalCrop">Culture rÃ©elle</label>
                <select class="form-select" name="actual_crop_id" id="modalCrop">
                    <option value="">â€” Choisir â€”</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="modalNotes">Notes</label>
                <input type="text" class="form-input" name="notes" id="modalNotes"
                    placeholder="Raison du remplacement...">
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-outline" id="modalCancel">Annuler</button>
            </div>
        </form>
    </div>
</div>

{# Crops data for JS filtering #}
<script>
    window.cropsByCategory = {{ crops_by_category | tojson }};
</script>
{% endblock %}